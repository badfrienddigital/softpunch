<!DOCTYPE html>
<!--
open http://localhost:8080
livereload ~/softpunch/softpunch/test/ -p 8080

-->

<html>
<head>
  <meta charset="utf-8">
	<title>MonoSynth</title>

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="icon" type="image/png" sizes="174x174" href="./style/favicon.png">

	<script src="/Tone.js"></script>


	<script>
		// jshint ignore: start
	</script>

</head>
<body>

<input type="button" id="button" value="hello" onclick="theButton()" />
<input type="button" id="button2" value="hello2" onclick="theButton2()" />




<script>

//
// using Tone.Frequency().transpose();
// and Tone.Frequency().harmonize([]);
// you can write every note based on its relationship
// to the fundamental;
// you would only hardcode the original root note
// and you could modulate that root note
// while preserving all harmonic relationships
// [perhaps just apply a few cents of randomness to it]
//

    var player = new Tone.Player().toMaster();
    var button = document.getElementById('button');
    var player2 = new Tone.Player().toMaster();
    var button2 = document.getElementById('button2');

    var lowCut = new Tone.Filter(-200, "lowshelf", -24);
    var masterLimit = new Tone.Limiter(-10);

    Tone.Master.chain(lowCut, masterLimit);
    Tone.Master.volume.value = -6;

    button.value = "Rendering..."
    button2.value = "2Rendering..."

    // render time for renderA
    var tt = Tone.Time("4m");
    var tt2 = Tone.Time("2m");



function renderA(){
      Tone.Offline(function(Transport){

            var volB = new Tone.Volume(0);
            volB.toMaster();
            var eqB = new Tone.EQ3(3, 0, -1);
            eqB.lowFrequency = 350;
            eqB.highFrequency = 700;
            eqB.connect(volB);
            var filterB = new Tone.Filter(525);
            filterB.Q = 1;
            filterB.rolloff = "-24";
            filterB.connect(eqB);

            var lfoB = new Tone.LFO("2m", 450, 575);
            lfoB.type = "sine";
            lfoB.connect(filterB.frequency).start();
            var synth2 = new Tone.Synth();
            synth2.connect(filterB);

            var lfoB2 = new Tone.LFO("2t", -1, -7);
            lfoB2.type = "triangle";
            lfoB2.phase = 0.5;
            lfoB2.connect(volB.volume).start();
            var lfoB3 = new Tone.LFO("2m", -1, -9);
            lfoB3.type = "sine";
            lfoB3.connect(volB.volume).start();

      synth2.set({
        "oscillator": {
        "type": "fatsawtooth"
      },
        "envelope": {
        "attack": 1,
        "decay": 0.5,
        "sustain": 1,
        "release": 2
        }
      })

      synth2.portamento.value = 0.1;
      synth2.volume.value = -8;

       //synth2.oscillator.count = 6;
       //synth2.oscillator.spread = 15;

      Transport.bpm.value = 115;

      var bassPart = new Tone.Part(function(time, note) {
          synth2.triggerAttackRelease(note, '2n', time);
      }, [[0, 'C2'],['2n', 'D2']]);

      var bassPart2 = new Tone.Part(function(time, note) {
          synth2.triggerAttackRelease(note, '2n', time);
      }, [[0, 'C3'],['2n', 'D2']]);

      bassPart.loop = 1;
      bassPart2.loop = 2;

      bassPart.start(0)
      bassPart2.start('1m');

  		// bassPart.probability = 0.95;
      // bassPart.humanize = 0.01;
      // humanize only works properly when rests are involved

      Tone.Transport.start("+0.1")
}, tt).then(function(buffer){
//set the buffer once it's rendered
player.buffer = buffer;
player.sync();
player.loop = true;
player.start(0);
button.value = "HitMe"

})
};

function renderB(){

  Tone.Offline(function(Transport){

      var filter1a = new Tone.Filter(4500, "lowpass");
      filter1a.toMaster();
      var fDelay1 = new Tone.FeedbackDelay("8n", 0.5);
      fDelay1.wet.value = 0.6;
      fDelay1.connect(filter1a);
      var vib1 = new Tone.Vibrato().connect(fDelay1);
      var synth1 = new Tone.MembraneSynth();
      synth1.connect(vib1);
      synth1.set({
          octaves: 1,
          envelope: {
              attack: 0.002,
              decay: 0.2,
              sustain: 0.05,
              release: 0.3,
              attackCurve: "cosine"
          },
      });

      synth1.volume.value = -6;
      Transport.bpm.value = 115;

      var malletPart = new Tone.Part(function(time, note) {
          synth1.triggerAttackRelease(note, '4n', time);
      }, [[0, 'C4'],['4n', 'E4'],['2m', 'G4']]);

      malletPart.start(0);
      //malletPart.probability = 0.95;
      malletPart.humanize = 0.01;
      Tone.Transport.start("+0.1")


}, (tt2 * 2)).then(function(buffer){
//set the buffer once it's rendered
player2.buffer = buffer;
player2.sync();
player2.loop = true;
button2.value = "Ready4Action"
player2.start(0);


})
};

  renderA();
  renderB();




function theButton(){

  var one = 1;
  var two = 2;
  var chooser = [one, two, one, two, one, two];
  var choiceNow = two;

  var randomWalk = new Tone.CtrlRandom({
      "min": 0,
      "max": 5,
      "integer": true
  });

  Tone.Transport.scheduleRepeat(function() {
      choiceNow = chooser[randomWalk.value];
  }, "4m", 0);

  Tone.Transport.scheduleRepeat(function() {
    if (choiceNow === 1) {
        player2.setLoopPoints(0, "1m");
    }
    else {
        player2.setLoopPoints("2m", "4m");
    }
  }, "4m", 0);

  // hoo boy....

  Tone.Transport.start("+0.2");
  button.value = "Playing";
};

function theButton2(){
  button2.value = "StillReady!";
};

</script>

</body>
</html>
