<!DOCTYPE html>
<!--
open http://localhost:8080
livereload ~/softpunch/softpunch/test/ -p 8080

-->

<html>
<head>
  <meta charset="utf-8">
	<title>MonoSynth</title>

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link rel="icon" type="image/png" sizes="174x174" href="./style/favicon.png">
	<script src="Tone.js"></script>


	<script>
		// jshint ignore: start
	</script>

</head>
<body>

<input type="button" id="button" value="hello" onclick="theButton()" />
<input type="button" id="button2" value="hello2" onclick="theButton2()" />

<script>

    var player = new Tone.Player().toMaster();
    var button = document.getElementById('button');
    var player2 = new Tone.Player().toMaster();
    var button2 = document.getElementById('button2');

    var lowCut = new Tone.Filter(-200, "lowshelf", -24);
    var mLimit = new Tone.Limiter(-15);
    var mDelay = new Tone.FeedbackDelay("32n", 0.25);
    mDelay.wet = 0.25;

    Tone.Master.chain(lowCut, mDelay, mLimit);
    Tone.Master.volume.value = -8;

    Tone.Transport.bpm.value = 115;
    Tone.Transport.swing.value = 0.2;
    Tone.Transport.latencyHint = 'playback';

    button.value = "Rendering..."
    button2.value = "2Rendering..."

    // render times
    var tt = Tone.Time("20m + 8n");
    var tt2 = Tone.Time("2m");



function renderA(){
      Tone.Offline(function(Transport){

            var volB = new Tone.Volume(0);
            volB.toMaster();
            var eqB = new Tone.EQ3(3, 0, -1);
            eqB.lowFrequency = 350;
            eqB.highFrequency = 700;
            eqB.connect(volB);
            var filterB = new Tone.Filter(525);
            filterB.Q = 1;
            filterB.rolloff = "-24";
            filterB.connect(eqB);

            var lfoB = new Tone.LFO("2m", 450, 575);
            lfoB.type = "sine";
            lfoB.connect(filterB.frequency).start();
            var synth2 = new Tone.Synth();
            synth2.connect(filterB);

            var lfoB2 = new Tone.LFO("2t", -1, -7);
            lfoB2.type = "triangle";
            lfoB2.phase = 0.5;
            lfoB2.connect(volB.volume).start();
            var lfoB3 = new Tone.LFO("2m", -1, -9);
            lfoB3.type = "sine";
            lfoB3.connect(volB.volume).start();

      synth2.set({
        "oscillator": {
        "type": "fatsawtooth"
      },
        "envelope": {
        "attack": 1,
        "decay": 0.5,
        "sustain": .8,
        "release": .2
        }
      })

      synth2.portamento.value = 0.1;
      synth2.volume.value = -2;

          var bassPart1 = new Tone.Part(function(time, event) {
              synth2.triggerAttackRelease(event.note, event.dur, time);
          }, [{time: '32n',note: 'C2',dur: '2m - 8n'}]);

          var bassPart2 = new Tone.Part(function(time, event) {
              synth2.triggerAttackRelease(event.note, event.dur, time);
          }, [{time: '32n',note: 'D2',dur: '2m - 8n'}]);

          var bassPart3 = new Tone.Part(function(time, event) {
              synth2.triggerAttackRelease(event.note, event.dur, time);
          }, [{time: '32n',note: 'E2',dur: '2m - 8n'}]);

          var bassPart4 = new Tone.Part(function(time, event) {
              synth2.triggerAttackRelease(event.note, event.dur, time);
          }, [{time: '32n',note: 'F1',dur: '2m - 8n'}]);

          var bassPart5 = new Tone.Part(function(time, event) {
              synth2.triggerAttackRelease(event.note, event.dur, time);
          }, [{time: '32n',note: 'F2',dur: '2m - 8n'}]);

          var bassPart6 = new Tone.Part(function(time, event) {
              synth2.triggerAttackRelease(event.note, event.dur, time);
          }, [{time: '32n',note: 'G2',dur: '2m - 8n'}]);

          var bassPart7 = new Tone.Part(function(time, event) {
              synth2.triggerAttackRelease(event.note, event.dur, time);
          }, [{time: '32n',note: 'A2',dur: '2m - 8n'}]);

          var bassPart8 = new Tone.Part(function(time, event) {
              synth2.triggerAttackRelease(event.note, event.dur, time);
          }, [{time: '32n',note: 'B2',dur: '2m - 8n'}]);

          var bassPart9 = new Tone.Part(function(time, event) {
              synth2.triggerAttackRelease(event.note, event.dur, time);
          }, [{time: '32n', note: 'G2', dur: '1m - 32n'},
              {time: '1m', note: 'D2', dur: '1m - 8n'}]);

          var bassPart10 = new Tone.Part(function(time, event) {
              synth2.triggerAttackRelease(event.note, event.dur, time);
          }, [{time: '32n', note: 'B2', dur: '1m - 32n'},
              {time: '1m', note: 'A2', dur: '1m - 8n'}]);

      bassPart1.start(0);
      bassPart2.start('2m');
      bassPart3.start('4m');
      bassPart4.start('6m');
      bassPart5.start('8m');
      bassPart6.start('10m');
      bassPart7.start('12m');
      bassPart8.start('14m');
      bassPart9.start('16m');
      bassPart10.start('18m');

      Tone.Transport.start("+0.1")
}, tt).then(function(buffer){
//set the buffer once it's rendered
player.buffer = buffer;
player.sync();
button.value = "HitMe"
})
};

function renderB(){

  Tone.Offline(function(Transport){

      var filter1a = new Tone.Filter(4500, "lowpass");
      filter1a.toMaster();
      var fDelay1 = new Tone.FeedbackDelay("8n", 0.5);
      fDelay1.wet.value = 0.55;
      fDelay1.connect(filter1a);
      var vib1 = new Tone.Vibrato().connect(fDelay1);
      var synth1 = new Tone.MembraneSynth();
      synth1.connect(vib1);
      synth1.set({
          octaves: 1,
          envelope: {
              attack: 0.002,
              decay: 0.2,
              sustain: 0.05,
              release: 0.3,
              attackCurve: "cosine"
          },
      });

      synth1.volume.value = -6;

      var malletPart1 = new Tone.Part(function(time, event) {
          synth1.triggerAttackRelease(event.note, event.dur, time);
      }, [
          {time: 0, note: 'C4', dur: '4n'},
          {time: '4n + 8n', note: 'E4', dur: '8n'},
          {time: '2n', note: 'G4', dur: '16n'},
          {time: '2n + 8t', note: 'B4', dur: '4t'},
          {time: '2n + 4n', note: 'C5', dur: '4n'},
          {time: '2n + 4n + 8t', note: 'B4', dur: '8n'}
      ]);

      var malletPart2 = new Tone.Part(function(time, event) {
          synth1.triggerAttackRelease(event.note, event.dur, time);
      }, [
          {time: 0, note: 'C4', dur: '4n'},
          {time: '4n + 8n', note: 'E4', dur: '8n'},
          {time: '2n', note: 'G4', dur: '16n'},
          {time: '2n + 8t', note: 'D5', dur: '4t'},
          {time: '2n + 4n', note: 'C5', dur: '4n'},
          {time: '2n + 4n + 8t', note: 'B4', dur: '8n'}
      ]);

      var malletPart3 = new Tone.Part(function(time, event) {
          synth1.triggerAttackRelease(event.note, event.dur, time);
      }, [
          {time: 0, note: 'C4', dur: '4n'},
          {time: '4n + 8n', note: 'E4', dur: '8n'},
          {time: '2n', note: 'G4', dur: '16n'},
          {time: '2n + 8t', note: 'B4', dur: '4t'},
          {time: '2n + 4n', note: 'B4', dur: '4n'},
          {time: '2n + 4n + 8t', note: 'C5', dur: '8n'}
      ]);

      var malletPart4 = new Tone.Part(function(time, event) {
          synth1.triggerAttackRelease(event.note, event.dur, time);
      }, [
          {time: 0, note: 'A4', dur: '8n'},
          {time: '8n', note: 'A4', dur: '8n'},
          {time: '4n + 8n', note: 'E4', dur: '8n'},
          {time: '2n', note: 'G4', dur: '16n'},
          {time: '2n + 8t', note: 'C4', dur: '4t'},
          {time: '2n + 4n + 8t', note: 'D4', dur: '8n'}
      ]);

      var malletPart5 = new Tone.Part(function(time, event) {
          synth1.triggerAttackRelease(event.note, event.dur, time);
      }, [
          {time: 0, note: 'D4', dur: '8n'},
          {time: '8n', note: 'A4', dur: '8n'},
          {time: '4n + 8n', note: 'A4', dur: '8n'},
          {time: '2n', note: 'E4', dur: '16n'},
          {time: '2n + 8t', note: 'G4', dur: '4t'},
          {time: '2n + 4n + 8t', note: 'C4', dur: '8n'}
      ]);

      malletPart1.start(0);
      malletPart2.start('2m');
      malletPart3.start('4m');
      malletPart4.start('6m');
      malletPart5.start('8m');

      malletPart1.probability = 0.95;
      malletPart2.probability = 0.95;
      malletPart3.probability = 0.95;
      malletPart4.probability = 0.95;
      malletPart5.probability = 0.95;

      malletPart1.humanize = 0.01;
      malletPart2.humanize = 0.02;
      malletPart3.humanize = 0.01;
      malletPart4.humanize = 0.02;
      malletPart5.humanize = 0.01;

      Tone.Transport.start("+0.1")

}, (tt2 * 5)).then(function(buffer){
//set the buffer once it's rendered
player2.buffer = buffer;
player2.sync();
button2.value = "Ready4Action"
})
};

  renderA();
  renderB();

var one = 1;
var two = 2;
var chooser = [one, two, one, two, one, two];
var choiceNow = two;

var randomWalk = new Tone.CtrlRandom({
    "min": 0,
    "max": 5,
    "integer": true
});

Tone.Transport.scheduleRepeat(function() {
    choiceNow = chooser[randomWalk.value];
    console.log("current section: " + choiceNow);
}, "2m", 0);

    var mp1 = 0;
    var mp2 = "2m";
    var mp3 = "4m";
    var mp4 = "6m";
    var mp5 = "8m";

    var malletNow = mp1;
    var malletList1 = [mp1, mp2, mp3, mp1, mp2, mp1];
    var malletList2 = [mp4, mp5, mp4, mp4, mp5, mp5];

    var bp1 = 0;
    var bp2 = "2m";
    var bp3 = "4m";
    var bp4 = "6m";
    var bp5 = "8m";
    var bp6 = "10m";
    var bp7 = "12m";
    var bp8 = "14m";
    var bp9 = "16m";
    var bp10 = "18m";

    var bassNow = bp1;
    var bassList1 = [bp2, bp4, bp5, bp7, bp2, bp5];
    var bassList2 = [bp7, bp4, bp3, bp9, bp10, bp7];

    Tone.Transport.scheduleRepeat(function() {
      if (choiceNow === 1) {
        // XXX: implement volume ramps
        bassNow = bassList1[randomWalk.value];
        malletNow = malletList1[randomWalk.value];

        //change from seek to start([startTime][, offset][, duration])
        // add retrigger true

        player.seek(bassNow);
        player2.seek(malletNow);
        console.log("bass: " + bassNow);
        console.log("mallets: " + malletNow);
      }
      else {
        // XXX: implement volume ramps
        bassNow = bassList2[randomWalk.value];
        malletNow = malletList2[randomWalk.value];
        player.seek(bassNow);
        player2.seek(malletNow);
        console.log("bass: " + bassNow);
        console.log("mallets: " + malletNow);
      }
    }, "2m", 0);


function theButton(){
  player.start(0);
  player2.start(0);
  Tone.Transport.start("+0.2");
  button.value = "Playing";
};

function theButton2(){
  button2.value = "StillReady!";
};

</script>

</body>
</html>
